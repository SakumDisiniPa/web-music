document.addEventListener("DOMContentLoaded",function(){!function(){function e(){fetch("/tracks").then(res=>res.json()).then(data=>{const container=document.getElementById("playlist-container");data.forEach(lagu=>{const div=document.createElement("div");div.className="playlist-card";const t=new Date(lagu.upload_date.replace(" ","T")).toLocaleDateString();div.innerHTML=`<a href="/play/${lagu.random_id}"><img src="${lagu.image}" alt="${lagu.name}"><div class="info"><h3>${lagu.name}</h3><p>${lagu.artist}</p><p class="description">${t}</p></div></a>`,container.appendChild(div)})}).catch(err=>{console.error(err),alert("Gagal memuat lagu.")})}function t(){document.getElementById("search-form").addEventListener("submit",function(t){t.preventDefault();const n=document.getElementById("search-input").value.toLowerCase(),a=document.querySelectorAll(".playlist-card");a.forEach(t=>{const a=t.querySelector("h3").textContent.toLowerCase(),o=t.querySelector("p").textContent.toLowerCase(),i=(t.querySelector(".description")?.textContent.toLowerCase()||"");t.style.display=a.includes(n)||o.includes(n)||i.includes(n)?"block":"none"})})}async function n(){try{const e=await fetch("/api/auth/status",{credentials:"include"});if(e.ok){const t=await e.json();a(t.isLoggedIn,t.user)}}catch(e){console.error("Error checking auth status:",e)}}function a(e,t=null){const n=document.querySelector(".auth-buttons"),a=document.getElementById("profile-dropdown"),o=document.querySelectorAll(".premium-feature");e&&a?(n&&(n.style.display="none"),a.style.display="block",t&&(function(){const e=document.getElementById("profile-picture"),n=document.getElementById("username-display");e&&(e.src=t.profilePicture||"/public/images/default-profile.png"),n&&(n.textContent=t.username||"User")}(),o.forEach(e=>e.style.display="block"))):(n&&(n.style.display="flex"),a&&(a.style.display="none"),o.forEach(e=>e.style.display="none"))}function o(){const e=document.getElementById("profile-button");if(!e)return;e.addEventListener("click",function(t){t.stopPropagation();const e=document.getElementById("dropdown-content");e&&(e.style.display="block"===e.style.display?"none":"block")}),document.addEventListener("click",function(){const e=document.getElementById("dropdown-content");e&&(e.style.display="none")});const t=document.getElementById("logout-btn");t&&t.addEventListener("click",async function(e){e.preventDefault();try{const t=await fetch("/api/auth/logout",{method:"POST",credentials:"include"});t.ok&&(window.location.href="/")}catch(e){console.error("Logout error:",e)}})}function i(e){const t=document.getElementById("playlist-container");t&&(t.innerHTML=`<div class="error-message"><i class="fas fa-exclamation-circle"></i><p>${e}</p><button onclick="location.reload()">Coba Lagi</button></div>`)}function r(){const e=document.querySelectorAll(".tab-button"),t=document.querySelectorAll(".tab-content");e.forEach(e=>{e.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),t.forEach(t=>t.classList.remove("active")),e.classList.add("active");const t=e.dataset.tab;document.getElementById(`${t}-tab`).classList.add("active")})})}function l(){const e=new URLSearchParams(window.location.search),t=e.get("id");t&&fetch(`/api/playlist/${t}`).then(e=>e.json()).then(e=>{document.title=e.playlist.judul,document.getElementById("playlist-title").textContent=e.playlist.judul;const t=document.getElementById("playlist-songs");e.tracks.forEach(e=>{const n=document.createElement("div");n.className="track",n.innerHTML=`<p><strong>${e.judul}</strong> - ${e.artis}</p><audio controls src="/data/audio/${e.nama_file_audio}"></audio>`,t.appendChild(n)})})}function d(){const e=document.getElementById("login-form");e&&e.addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("email").value.trim(),n=document.getElementById("password").value,a=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email_or_username:t,password:n})}),o=await a.json(),i=document.getElementById("response-message");a.ok?(i.style.color="lightgreen",i.textContent="Login berhasil! Mengalihkan...",setTimeout(()=>{window.location.href="/"},1500)):(i.style.color="salmon",i.textContent=o.error||"Login gagal.")})}function c(){const e=document.getElementById("register-form");e&&e.addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("username").value.trim(),n=document.getElementById("email").value.trim(),a=document.getElementById("password").value,o=await fetch("/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,email:n,password:a})}),i=await o.json(),r=document.getElementById("response-message");o.ok?(r.style.color="lightgreen",r.textContent="Akun berhasil dibuat! Silakan cek email untuk verifikasi.",e.reset()):(r.style.color="salmon",r.textContent=i.error||"Terjadi kesalahan saat mendaftar.")})}function s(){const e=new URLSearchParams(window.location.search),t=e.get("id");let n={};let a=!1;async function o(){if(!t)return void(alert("ID Lagu tidak valid!"),window.location.href="/admin");try{const e=await fetch(`/api/lagu/${t}`);if(!e.ok)throw new Error("Gagal mengambil data lagu");const a=await e.json();document.getElementById("judulLagu").value=a.judul,document.getElementById("namaArtis").value=a.artis,document.getElementById("deskripsiLagu").value=a.deskripsi;const o=document.getElementById("thumbnailPreview");a.thumbnail&&(o.innerHTML=`<img src="${a.thumbnail}" alt="Thumbnail">`),n={judul:a.judul,artis:a.artis,deskripsi:a.deskripsi,thumbnail:a.thumbnail},a=!1,i()}catch(e){console.error("Error:",e),alert(e.message||"Terjadi kesalahan saat memuat data"),window.location.href="admin.html"}}function i(){const e=document.getElementById("judulLagu").value,t=document.getElementById("namaArtis").value,o=document.getElementById("deskripsiLagu").value,r=e!==n.judul,l=t!==n.artis,d=o!==n.deskripsi;document.getElementById("indikatorJudul").style.display=r?"inline":"none",document.getElementById("indikatorArtis").style.display=l?"inline":"none",document.getElementById("indikatorDeskripsi").style.display=d?"inline":"none",document.getElementById("tombolSimpan").disabled=!(r||l||d||a)}function r(e){const t=e.files[0];if(t){if(!t.type.startsWith("image/"))return void alert("File harus berupa gambar!");const n=new FileReader;n.onload=function(e){document.getElementById("thumbnailPreview").innerHTML=`<img src="${e.target.result}" alt="Thumbnail">`,a=!0,i()},n.readAsDataURL(t)}}function l(){window.location.href="admin.html"}async function d(){if(confirm("Apakah Anda yakin ingin menghapus lagu ini?"))try{const e=await fetch(`/api/lagu/${t}`,{method:"DELETE"});if(!e.ok)throw new Error("Gagal menghapus lagu");alert("Lagu berhasil dihapus!"),window.location.href="/admin"}catch(e){console.error("Error:",e),alert(e.message||"Gagal menghapus lagu")}}async function c(){const e=new FormData;e.append("judul",document.getElementById("judulLagu").value),e.append("artis",document.getElementById("namaArtis").value),e.append("deskripsi",document.getElementById("deskripsiLagu").value);const t=document.getElementById("fileInput");t.files[0]&&e.append("thumbs",t.files[0]);try{const t=await fetch(`/api/lagu/${t}`,{method:"PUT",body:e});if(!t.ok)throw new Error("Gagal menyimpan perubahan");alert("Perubahan berhasil disimpan!"),window.location.href="admin.html"}catch(e){console.error("Error:",e),alert(e.message)}}window.onload=o}function u(){const e=document.getElementById("audio"),t=document.getElementById("seekbar"),n=document.getElementById("currentTime"),a=document.getElementById("duration"),o=document.getElementById("playBtn"),i=document.getElementById("downloadBtn"),r=document.getElementById("title"),l=document.getElementById("artist"),d=document.getElementById("cover");let c=!1,s=[],u=0;function m(e,t){let a=`üéµ ${e} - ${t}`;document.title=a;let o=document.querySelector('meta[property="og:title"]'),i=document.querySelector('meta[property="og:description"]');o&&o.setAttribute("content",a),i&&i.setAttribute("content",`Sedang mendengarkan ${e} - ${t}`)}function f(){window.playlistData&&window.playlistData.tracks?(s=window.playlistData.tracks,u=window.playlistData.currentIndex||0,s.length>0?h(u):i("Tidak ada lagu dalam playlist")):i("Gagal memuat data playlist")}function p(){e.paused?(e.play().catch(e=>{console.warn("Autoplay ditolak:",e),o.textContent="‚ñ∂"}),o.textContent="‚è∏"):(e.pause(),o.textContent="‚ñ∂")}function h(t){if(t<0||t>=s.length)return;let n=s[t];u=t,r.textContent=n.title||"Judul tidak tersedia",l.textContent=n.artist||"Artis tidak tersedia",d.src=n.image||"/public/thumbs/default.jpg",m(n.title,n.artist),e.src=n.audio_url,i.href=n.audio_url,i.download=`${n.title||"lagu"}.mp3`,t.value=0,n.textContent="00:00",a.textContent="00:00",e.play().catch(e=>{console.log("Autoplay tidak diizinkan, menunggu interaksi pengguna"),o.textContent="‚ñ∂"}),history.replaceState(null,null,`/play/${n.random_id}`)}function g(){h(u=(u-1+s.length)%s.length)}function y(){h(u=(u+1)%s.length)}function v(e){if(isNaN(e))return"00:00";let t=Math.floor(e/60).toString().padStart(2,"0"),n=Math.floor(e%60).toString().padStart(2,"0");return`${t}:${n}`}function b(e){r.textContent=e,l.textContent="",o.disabled=!0,document.title=`Error - ${e}`}e.addEventListener("play",()=>{c=!0,o.textContent="‚è∏"}),e.addEventListener("pause",()=>{c=!1,o.textContent="‚ñ∂"}),e.addEventListener("loadedmetadata",()=>{t.max=Math.floor(e.duration),a.textContent=v(e.duration)}),e.addEventListener("timeupdate",()=>{t.value=Math.floor(e.currentTime),n.textContent=v(e.currentTime)}),e.addEventListener("ended",y),t.addEventListener("input",()=>{e.currentTime=t.value}),document.addEventListener("keydown",e=>{switch(e.code){case"Space":e.preventDefault(),p();break;case"ArrowLeft":e.currentTime=Math.max(0,e.currentTime-5);break;case"ArrowRight":e.currentTime=Math.min(e.duration,e.currentTime+5);break;case"ArrowUp":e.volume=Math.min(1,e.volume+.1);break;case"ArrowDown":e.volume=Math.max(0,e.volume-.1)}}),window.addEventListener("DOMContentLoaded",f)}function m(){const e=document.querySelectorAll(".tab-button");e.forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".tab-button").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),e.classList.add("active");const t=e.getAttribute("data-tab");document.getElementById(`${t}-tab`).classList.add("active")})})}function f(){const e=document.getElementById("youtubeForm"),t=document.getElementById("spotifyForm"),n=document.getElementById("playlistForm"),a=document.getElementById("result"),o=document.getElementById("youtubeDownloadBtn"),i=document.getElementById("spotifyDownloadBtn"),r=document.getElementById("playlistDownloadBtn"),l=document.getElementById("progressBar"),d=document.getElementById("progressText"),c=document.getElementById("playlistResults");function s(e,t){a.innerHTML=`<div class="${t}">${e}</div>`}function u(e){return`<div class="track-info"><p><strong>Judul:</strong> ${e.judul}</p><p><strong>Artis:</strong> ${e.artis}</p>${e.deskripsi?`<p><strong>Deskripsi:</strong> ${e.deskripsi}</p>`:""}<img src="${e.thumbnail}" alt="Album cover"></div>`}function m(e,t,n,a){const o=Math.round((e/t)*100);l.style.width=`${o}%`,d.textContent=`Memproses ${e} dari ${t} lagu (${n} berhasil, ${a} gagal)`}function p(e,t){c.innerHTML="",e.length>0&&(function(e){const t=document.createElement("div");t.innerHTML=`<h3>${e.length} Lagu Berhasil Diunduh</h3>`,e.forEach(e=>{t.innerHTML+=u(e)}),c.appendChild(t)}(e)),t.length>0&&(function(e){const t=document.createElement("div");t.innerHTML=`<h3>${e.length} Lagu Gagal Diunduh</h3>`,e.forEach(e=>{t.innerHTML+=`<div class="error">${e}</div>`}),c.appendChild(t)}(t))}e.addEventListener("submit",async t=>{t.preventDefault();const n=document.getElementById("youtubeUrl").value;if(!n.includes("youtube.com")&&!n.includes("youtu.be"))return void s("‚ùå Masukkan URL YouTube yang valid","error");o.disabled=!0,s("‚è≥ Memproses lagu dari YouTube...","loading");try{const t=await fetch("/admin/get-metadata",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:n})});if(!t.ok)throw new Error("Gagal mengambil metadata");const a=await t.json();if(!a.success)throw new Error(a.error||"Metadata tidak valid");const i=await fetch("/admin/upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:n,judul:a.judul,artis:a.artis,deskripsi:a.deskripsi})}),r=await i.json();i.ok&&r.success?(a.innerHTML=`<div class="success">‚úÖ <strong>${r.message}</strong></div>${u(r)}`,e.reset()):(console.error("Upload failed:",r),s(`‚ùå ${r.error||"Upload gagal"}`,"error"))}catch(t){console.error(t),s(`‚ùå ${t.message||"Terjadi kesalahan saat memproses YouTube"}`,"error")}finally{o.disabled=!1}}),t.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("spotifyUrl").value;if(!t.includes("spotify.com"))return void s("‚ùå Masukkan URL Spotify yang valid","error");i.disabled=!0,s("‚è≥ Memproses lagu dari Spotify...","loading");try{const e=await fetch("/admin/upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t,judul:null,artis:null,deskripsi:null})}),n=await e.json();e.ok&&n.success?(a.innerHTML=`<div class="success">‚úÖ <strong>${n.message}</strong></div>${u(n)}`,t.reset()):(console.error("Upload failed:",n),s(`‚ùå ${n.error||"Upload gagal"}`,"error"))}catch(e){console.error(e),s(`‚ùå ${e.message||"Terjadi kesalahan saat memproses Spotify"}`,"error")}finally{i.disabled=!1}}),n.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("playlistUrl").value;l.style.width="0%",d.textContent="Memulai...",c.innerHTML="",document.getElementById("playlistProgress").style.display="block";const a=new EventSource(`/admin/download-playlist?url=${encodeURIComponent(t)}`);a.onmessage=e=>{const t=JSON.parse(e.data);if(t.error)return s(`‚ùå ${t.error}`,"error"),void a.close();t.total&&(d.textContent=`Memproses 0 dari ${t.total} lagu...`),t.current&&(function(e){const n=Math.round((e.current/e.total)*100);l.style.width=`${n}%`;let a=`Memproses ${e.current}/${e.total}`;e.message&&(a+=` - ${e.message}`),e.success&&(a+=` (${e.success} berhasil)`),e.failed&&(a+=` (${e.failed} gagal)`),d.textContent=a}(t)),"completed"===t.status&&(a.close(),s(`‚úÖ Selesai! ${t.success}/${t.total} lagu berhasil`,"success"),t.failed>0&&(function(e){const t=document.createElement("div");t.innerHTML=`<h4>Gagal memproses ${e} lagu:</h4>`,e.forEach(e=>{t.innerHTML+=`<div class="error">${e}</div>`}),c.appendChild(t)}(t.errors)))},a.onerror=()=>{s("‚ùå Koneksi terputus","error"),a.close()}})}n(),a(),o(),r(),l(),d(),c(),s(),u(),m(),f()}(),checkAuthStatus=n,loadPublicTracks=e,setupSearch=t,setupProfileDropdown=o,initAudioPlayer=u});